# Go Auth Service

**Go Auth** — это сервис аутентификации. 
Он предоставляет механизмы регистрации, входа, обновления токенов и выхода для пользователей. 
Это только пример, сервис не боевой

## Технологии

- **Go** — основной язык разработки.
- **gRPC** — механизм для создания RPC-сервисов.
- **gRPC-Gateway** — REST API Gateway для фронтенда (транслирует REST в gRPC).
- **PostgreSQL** — реляционная база данных для хранения данных пользователей.
- **Redis** — для хранения токенов и сессий пользователей.
- **JWT** — JSON Web Token для аутентификации пользователей.

## Структура проекта

Проект реализует **чистую архитектуру**, разделяя код на несколько слоев, 
что улучшает тестируемость, поддерживаемость и расширяемость. 
Структура проекта следующая:

### Корень проекта
- **cmd/app** — точка входа. Содержит файл `main.go`, который вызывает 
- функцию `Run` из файла `internal/app/app.go`.

- **config** — конфигурации проекта, включая параметры для работы с базой данных, 
аутентификацией и другими сервисами.
- **internal** — реализация чистой архитектуры, включая следующие слои:
  - **app** — здесь реализуется запуск приложения.
  - **entity** — модели данных, представляющие бизнес-объекты, которые используются
  - **adapter** — взаимодействует с внешними системами и сервисами
  - **controller** — обрабатывает входящие запросы и передает их в слой `usecase` 
    для дальнейшей обработки. В этом проекте используется gRPC для обработки запросов.
  в других слоях, такие как пользователь.
  - **usecase** — бизнес-логика, которая инкапсулирует правила обработки данных и 
  выполнения операций, таких как аутентификация и управление сессиями.
  - **repo** — слой для работы с базой данных. В этом проекте используется PostgreSQL через 
  драйвер `lib/pq` для взаимодействия с хранилищем данных.
- **proto** - gprc контракты
- **gen** — сгенерированный код для gRPC.
- **pkg** — вспомогательные пакеты
- **migrations** — миграции базы данных.

## Хранение токенов в Redis

### Где хранятся токены

| Тип данных | Ключ в Redis | TTL | Описание |
|------------|--------------|-----|----------|
| **Access токены** | `access_token:<token>` | 30 мин | Активные access токены с привязкой к userID |
| **Refresh токены** | `refresh_token:<token>` | 30 дней | Активные refresh токены с привязкой к userID |
| **Access токены пользователя** | `user_access:<userID>` | 30 мин | Set со всеми access токенами пользователя |
| **Refresh сессии пользователя** | `user_sessions:<userID>` | 30 дней | Set со всеми refresh токенами пользователя |

### Как это работает

1. **При Login**:
   - Генерируются access и refresh токены (JWT)
   - **Access токен сохраняется в Redis** с TTL = 30 минут
   - **Refresh токен сохраняется в Redis** с TTL = 30 дней
   - Оба токена добавляются в соответствующие списки пользователя

2. **При RefreshToken**:
   - Проверяется валидность JWT (подпись, срок действия)
   - Проверяется наличие refresh токена в Redis (не был отозван)
   - Генерируется новый access токен
   - **Новый access токен сохраняется в Redis**

3. **При ValidateToken**:
   - Проверяется валидность JWT (подпись, срок действия)
   - **Проверяется наличие access токена в Redis** (не был отозван)

4. **При Logout**:
   - **Access токен удаляется из Redis** (мгновенная инвалидация)

5. **При LogoutAll**:
   - Удаляются **все access и refresh токены** пользователя
   - Очищаются списки сессий

### Преимущества хранения всех токенов в Redis

- **Полный контроль**: Можно отозвать любой токен в любой момент
- **Мгновенная инвалидация**: При logout токен сразу становится недействительным
- **Управление сессиями**: Возможность выйти на всех устройствах (LogoutAll)
- **TTL**: Автоматическая очистка истекших записей
- **Скорость**: O(1) для всех операций с токенами

## Установка

### 1. Клонирование репозитория

Для начала, клонируйте репозиторий:

```bash
git clone git@gitlab.dev-api.tech:cyberball/auth.git
```

### 2. Установка зависимостей

Перейдите в папку проекта и установите все зависимости:

```bash
go mod tidy
```

### 3. Настройка конфигурации

Создайте файл конфигурации: *config/config.yaml*. Пример:
```yaml
app:
  name: "app" # Имя приложения
  version: "0.0.1" # Версия приложения

grpc:
  port: 12345
  timeout: 30

logger:
  level: 'debug'

token:
  accessTTL: "30m"
  refreshTTL: "720h"

migrations:
  path: "path/to/migrations"
```
В корне проекта добавьте свой *.env* файл. Пример:
```text
MIGRATIONS_PATH=/custom/migrations

TOKEN_SECRET=SUPER_SECRET

# PostgreSQL конфигурация
PG_USER=admin
PG_PASSWORD=supersecurepassword
PG_HOST=db.example.com
PG_PORT=5432
PG_DBNAME=name

# Redis конфигурация
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
```

### 4. Запуск проекта

Перед запуском необходимо выполнить миграции базы данных:
```bash
go run cmd/migrate.go
```
или
```bash
make migrate-up
```
Затем запустите приложение:
```bash
go run cmd/main.go
```
или
```bash
make run
```

### 5. Запуск в Docker

Шаг 4 можно пропустить и запустить в Docker:
```bash
docker compose up --build
```

## Технология JWT (JSON Web Tokens)

Для аутентификации и авторизации в сервисе используется JWT. JWT позволяет безопасно передавать информацию между
клиентом и сервером в виде токенов.
- Access Token — короткоживущий токен, используемый для подтверждения аутентификации пользователя.
- Refresh Token — долгоживущий токен, используемый для получения нового access token, когда старый истекает.

### Пример работы с токенами
1. Пользователь регистрируется или входит в систему. 
2. Сервер генерирует два токена:
   - access_token (для доступа к защищённым маршрутам).
   - refresh_token (для обновления access token).
3. Токены передаются клиенту, который использует их для аутентификации при последующих запросах.

## REST API Gateway

Сервис предоставляет **REST API** через gRPC-Gateway для фронтенда.

### Доступные endpoints:

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/v1/auth/register` | Регистрация пользователя |
| POST | `/api/v1/auth/login` | Вход в систему |
| POST | `/api/v1/auth/refresh` | Обновление access токена |
| POST | `/api/v1/auth/validate` | Проверка токена |
| POST | `/api/v1/auth/logout` | Выход из системы |

### Примеры запросов:

**Регистрация:**
```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'
```

**Вход:**
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'
```

**Обновление токена:**
```bash
curl -X POST http://localhost:8080/api/v1/auth/refresh \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "YOUR_REFRESH_TOKEN"}'
```

**Выход (logout):**
```bash
curl -X POST http://localhost:8080/api/v1/auth/logout \
  -H "Content-Type: application/json" \
  -d '{"refresh_token": "YOUR_REFRESH_TOKEN"}'
```

### Порты:

- **gRPC**: `60051` (для внутренних сервисов)
- **REST API**: `8080` (для фронтенда)

## Тестирование
Для запуска тестов используйте команду:

```bash
go test ./...
```
