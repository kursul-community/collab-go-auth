{
  "openapi": "3.1.0",
  "info": {
    "title": "Go Auth API",
    "description": "API аутентификации и авторизации пользователей с поддержкой OAuth2",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "/api/v1",
      "description": "API server"
    }
  ],
  "paths": {
    "/auth/register": {
      "post": {
        "tags": ["Auth"],
        "summary": "Регистрация пользователя",
        "description": "Создает нового пользователя и отправляет код верификации на email. Возвращает user_id и request_id для последующей верификации.",
        "operationId": "register",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RegisterRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Пользователь успешно зарегистрирован",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RegisterResponse"
                }
              }
            }
          },
          "400": {
            "description": "Некорректные данные запроса",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "409": {
            "description": "Пользователь с таким email уже существует",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/login": {
      "post": {
        "tags": ["Auth"],
        "summary": "Вход в систему",
        "description": "Аутентификация пользователя по email и паролю. Возвращает access и refresh токены в JSON ответе и устанавливает их в cookies. Токены сохраняются в Redis для возможности отзыва.\n\n**Cookies:**\n- `access_token` - HttpOnly, Max-Age: 1800 (30 минут), SameSite: Lax\n- `refresh_token` - НЕ HttpOnly (доступен из JavaScript), Max-Age: 2592000 (30 дней), SameSite: Lax",
        "operationId": "login",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LoginRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Успешная аутентификация. Токены возвращаются в JSON и устанавливаются в cookies.",
            "headers": {
              "Set-Cookie": {
                "description": "Cookies с токенами: access_token (HttpOnly) и refresh_token (доступен из JS)",
                "schema": {
                  "type": "string",
                  "example": "access_token=eyJ...; Path=/; Max-Age=1800; HttpOnly; SameSite=Lax, refresh_token=eyJ...; Path=/; Max-Age=2592000; SameSite=Lax"
                }
              }
            },
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LoginResponse"
                }
              }
            }
          },
          "400": {
            "description": "Некорректные данные запроса",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "401": {
            "description": "Неверные учетные данные",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/refresh": {
      "post": {
        "tags": ["Auth"],
        "summary": "Обновление access токена",
        "description": "Получение нового access токена по refresh токену. Проверяет валидность refresh токена (подпись, срок действия, наличие в Redis) и генерирует новый access токен. Новый access токен устанавливается в cookie.\n\n**Cookies:**\n- `access_token` - HttpOnly, Max-Age: 1800 (30 минут), SameSite: Lax",
        "operationId": "refreshToken",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RefreshTokenRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Токен успешно обновлен. Новый access токен возвращается в JSON и устанавливается в cookie.",
            "headers": {
              "Set-Cookie": {
                "description": "Cookie с новым access токеном (HttpOnly)",
                "schema": {
                  "type": "string",
                  "example": "access_token=eyJ...; Path=/; Max-Age=1800; HttpOnly; SameSite=Lax"
                }
              }
            },
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RefreshTokenResponse"
                }
              }
            }
          },
          "400": {
            "description": "Некорректный формат refresh токена",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "401": {
            "description": "Невалидный или истекший refresh токен, либо токен был отозван",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/validate": {
      "post": {
        "tags": ["Auth"],
        "summary": "Проверка access токена",
        "description": "Проверяет валидность access токена (подпись, срок действия, наличие в Redis)",
        "operationId": "validateToken",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ValidateTokenRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Результат проверки токена",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ValidateTokenResponse"
                }
              }
            }
          },
          "400": {
            "description": "Некорректный формат токена",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/sign-up/verify-email": {
      "post": {
        "tags": ["Email Verification"],
        "summary": "Верификация email",
        "description": "Подтверждение email по 6-значному коду. Используйте user_id и request_id из ответа /auth/register",
        "operationId": "verifyEmail",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/VerifyEmailRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Email успешно подтвержден",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EmptyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Неверный код верификации или невалидный request_id",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "404": {
            "description": "Пользователь не найден",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "409": {
            "description": "Email уже подтвержден",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/sign-up/resend-email": {
      "post": {
        "tags": ["Email Verification"],
        "summary": "Повторная отправка кода верификации",
        "description": "Отправляет новый код верификации на email. Используйте user_id и request_id из ответа /auth/register",
        "operationId": "resendVerificationEmail",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ResendVerificationEmailRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Код успешно отправлен",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EmptyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Невалидный request_id",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "404": {
            "description": "Пользователь не найден",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "409": {
            "description": "Email уже подтвержден",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/restore-password/begin": {
      "post": {
        "tags": ["Password Recovery"],
        "summary": "Начало восстановления пароля",
        "description": "Отправляет письмо со ссылкой для сброса пароля на указанный email",
        "operationId": "restorePasswordBegin",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RestorePasswordBeginRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Письмо отправлено (даже если пользователь не существует - для безопасности)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EmptyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Некорректный email",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/restore-password/complete": {
      "post": {
        "tags": ["Password Recovery"],
        "summary": "Завершение восстановления пароля",
        "description": "Устанавливает новый пароль. user_id и request_id берутся из ссылки в email",
        "operationId": "restorePasswordComplete",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RestorePasswordCompleteRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Пароль успешно изменен",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/EmptyResponse"
                }
              }
            }
          },
          "400": {
            "description": "Невалидный или истекший токен сброса пароля",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "404": {
            "description": "Пользователь не найден",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/oauth/{provider}": {
      "get": {
        "tags": ["OAuth2"],
        "summary": "ШАГ 2-3: Получить URL авторизации провайдера",
        "description": "**Что происходит:**\n1. Client запрашивает ссылку для авторизации через провайдера\n2. Auth Server генерирует URL с параметрами (client_id, redirect_uri, scope, state)\n3. Auth Server возвращает URL для перенаправления пользователя\n\n**State** - случайная строка для защиты от CSRF атак",
        "operationId": "oauthGetAuthUrl",
        "parameters": [
          {
            "name": "provider",
            "in": "path",
            "required": true,
            "description": "Провайдер OAuth2",
            "schema": {
              "$ref": "#/components/schemas/OAuthProvider"
            }
          },
          {
            "name": "redirect_uri",
            "in": "query",
            "required": false,
            "description": "URL для возврата после авторизации (по умолчанию из конфига)",
            "schema": {
              "type": "string",
              "format": "uri",
              "example": "http://localhost:5173/auth/callback"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "URL для перенаправления пользователя на страницу провайдера",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthAuthUrlResponse"
                }
              }
            }
          },
          "400": {
            "description": "Неподдерживаемый провайдер",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/oauth/{provider}/callback": {
      "get": {
        "tags": ["OAuth2"],
        "summary": "ШАГ 9-13: Callback после авторизации у провайдера",
        "description": "**Что происходит:**\n1. Пользователь подтвердил доступ у провайдера (Google/GitHub/etc)\n2. Провайдер редиректит сюда с authorization code\n3. Auth Server обменивает code на access_token провайдера\n4. Auth Server получает данные пользователя (email, name) от провайдера\n5. Auth Server создаёт/находит пользователя в БД\n6. Auth Server генерирует свои JWT токены\n7. Возвращает токены клиенту\n\n**Важно:** Этот endpoint вызывается автоматически провайдером!",
        "operationId": "oauthCallback",
        "parameters": [
          {
            "name": "provider",
            "in": "path",
            "required": true,
            "description": "Провайдер OAuth2",
            "schema": {
              "$ref": "#/components/schemas/OAuthProvider"
            }
          },
          {
            "name": "code",
            "in": "query",
            "required": true,
            "description": "Authorization code от провайдера (одноразовый, живёт ~10 минут)",
            "schema": {
              "type": "string",
              "example": "4/0AX4XfWh..."
            }
          },
          {
            "name": "state",
            "in": "query",
            "required": true,
            "description": "State для защиты от CSRF (должен совпадать с отправленным)",
            "schema": {
              "type": "string",
              "example": "abc123xyz"
            }
          },
          {
            "name": "error",
            "in": "query",
            "required": false,
            "description": "Код ошибки, если пользователь отклонил доступ",
            "schema": {
              "type": "string",
              "example": "access_denied"
            }
          }
        ],
        "responses": {
          "302": {
            "description": "Редирект на фронтенд с токенами в URL или cookie",
            "headers": {
              "Location": {
                "description": "URL фронтенда с параметрами",
                "schema": {
                  "type": "string",
                  "example": "http://localhost:5173/auth/callback?access_token=...&refresh_token=..."
                }
              },
              "Set-Cookie": {
                "description": "JWT токены в httpOnly cookies (опционально)",
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "400": {
            "description": "Невалидный code или state",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          },
          "401": {
            "description": "Пользователь отклонил доступ",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiError"
                }
              }
            }
          }
        }
      }
    },
    "/auth/oauth/providers": {
      "get": {
        "tags": ["OAuth2"],
        "summary": "Список доступных OAuth2 провайдеров",
        "description": "Возвращает список включённых OAuth2 провайдеров для отображения кнопок на фронтенде",
        "operationId": "oauthListProviders",
        "responses": {
          "200": {
            "description": "Список провайдеров",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/OAuthProvidersListResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ApiError": {
        "type": "object",
        "required": ["message"],
        "properties": {
          "message": {
            "type": "string",
            "description": "Текст ошибки"
          }
        }
      },
      "EmptyResponse": {
        "type": "object",
        "description": "Пустой ответ при успехе"
      },
      "RegisterRequest": {
        "type": "object",
        "required": ["email", "password"],
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "description": "Email пользователя",
            "example": "user@example.com"
          },
          "password": {
            "type": "string",
            "minLength": 6,
            "maxLength": 128,
            "description": "Пароль (6-128 символов)",
            "example": "securePassword123"
          }
        }
      },
      "RegisterResponse": {
        "type": "object",
        "required": ["user_id", "request_id"],
        "properties": {
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID созданного пользователя",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "request_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID запроса для верификации email (используйте для verify-email и resend-email)",
            "example": "7c9e6679-7425-40de-944b-e07fc1f90ae7"
          }
        }
      },
      "LoginRequest": {
        "type": "object",
        "required": ["email", "password"],
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "description": "Email пользователя",
            "example": "user@example.com"
          },
          "password": {
            "type": "string",
            "description": "Пароль",
            "example": "securePassword123"
          }
        }
      },
      "LoginResponse": {
        "type": "object",
        "required": ["accessToken", "refreshToken"],
        "properties": {
          "accessToken": {
            "type": "string",
            "description": "JWT access токен для авторизации запросов. Также устанавливается в cookie `access_token` (HttpOnly, 30 минут)",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          },
          "refreshToken": {
            "type": "string",
            "description": "JWT refresh токен для обновления access токена. Также устанавливается в cookie `refresh_token` (доступен из JavaScript, 30 дней)",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          }
        }
      },
      "RefreshTokenRequest": {
        "type": "object",
        "required": ["refreshToken"],
        "properties": {
          "refreshToken": {
            "type": "string",
            "description": "Refresh токен (можно передать в теле запроса или использовать из cookie `refresh_token`)",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          }
        }
      },
      "RefreshTokenResponse": {
        "type": "object",
        "required": ["accessToken"],
        "properties": {
          "accessToken": {
            "type": "string",
            "description": "Новый JWT access токен. Также устанавливается в cookie `access_token` (HttpOnly, 30 минут)",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          }
        }
      },
      "ValidateTokenRequest": {
        "type": "object",
        "required": ["access_token"],
        "properties": {
          "access_token": {
            "type": "string",
            "description": "Access токен для проверки",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          }
        }
      },
      "ValidateTokenResponse": {
        "type": "object",
        "required": ["valid"],
        "properties": {
          "valid": {
            "type": "boolean",
            "description": "Валиден ли токен",
            "example": true
          }
        }
      },
      "VerifyEmailRequest": {
        "type": "object",
        "required": ["user_id", "request_id", "code"],
        "properties": {
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID пользователя (из ответа /auth/register)",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "request_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID запроса верификации (из ответа /auth/register)",
            "example": "7c9e6679-7425-40de-944b-e07fc1f90ae7"
          },
          "code": {
            "type": "string",
            "pattern": "^[0-9]{6}$",
            "description": "6-значный код верификации из email",
            "example": "123456"
          }
        }
      },
      "ResendVerificationEmailRequest": {
        "type": "object",
        "required": ["user_id", "request_id"],
        "properties": {
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID пользователя (из ответа /auth/register)",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "request_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID запроса верификации (из ответа /auth/register)",
            "example": "7c9e6679-7425-40de-944b-e07fc1f90ae7"
          }
        }
      },
      "RestorePasswordBeginRequest": {
        "type": "object",
        "required": ["email"],
        "properties": {
          "email": {
            "type": "string",
            "format": "email",
            "description": "Email пользователя для восстановления пароля",
            "example": "user@example.com"
          }
        }
      },
      "RestorePasswordCompleteRequest": {
        "type": "object",
        "required": ["user_id", "request_id", "password"],
        "properties": {
          "user_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID пользователя (из ссылки в email)",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "request_id": {
            "type": "string",
            "format": "uuid",
            "description": "UUID запроса восстановления (из ссылки в email)",
            "example": "a11e1d87-ca6f-44fe-ba44-5473cd0a0dc0"
          },
          "password": {
            "type": "string",
            "minLength": 6,
            "maxLength": 128,
            "description": "Новый пароль (6-128 символов)",
            "example": "newSecurePassword123"
          }
        }
      },
      "OAuthProvider": {
        "type": "string",
        "enum": ["google", "github", "yandex", "vk"],
        "description": "Поддерживаемые OAuth2 провайдеры",
        "example": "google"
      },
      "OAuthAuthUrlResponse": {
        "type": "object",
        "required": ["auth_url", "state"],
        "properties": {
          "auth_url": {
            "type": "string",
            "format": "uri",
            "description": "URL для перенаправления пользователя на страницу провайдера",
            "example": "https://accounts.google.com/o/oauth2/v2/auth?client_id=...&redirect_uri=...&scope=email%20profile&state=abc123&response_type=code"
          },
          "state": {
            "type": "string",
            "description": "Случайный state для CSRF защиты (сохраните и проверьте в callback)",
            "example": "abc123xyz789"
          }
        }
      },
      "OAuthProvidersListResponse": {
        "type": "object",
        "required": ["providers"],
        "properties": {
          "providers": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/OAuthProviderInfo"
            },
            "description": "Список доступных провайдеров"
          }
        }
      },
      "OAuthProviderInfo": {
        "type": "object",
        "required": ["name", "enabled"],
        "properties": {
          "name": {
            "$ref": "#/components/schemas/OAuthProvider"
          },
          "display_name": {
            "type": "string",
            "description": "Отображаемое имя провайдера",
            "example": "Google"
          },
          "enabled": {
            "type": "boolean",
            "description": "Включён ли провайдер",
            "example": true
          },
          "icon_url": {
            "type": "string",
            "format": "uri",
            "description": "URL иконки провайдера",
            "example": "https://example.com/icons/google.svg"
          }
        }
      }
    },
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "JWT токен в заголовке Authorization"
      },
      "OAuth2Google": {
        "type": "oauth2",
        "description": "OAuth2 авторизация через Google",
        "flows": {
          "authorizationCode": {
            "authorizationUrl": "https://accounts.google.com/o/oauth2/v2/auth",
            "tokenUrl": "https://oauth2.googleapis.com/token",
            "scopes": {
              "email": "Доступ к email пользователя",
              "profile": "Доступ к профилю пользователя"
            }
          }
        }
      },
      "OAuth2GitHub": {
        "type": "oauth2",
        "description": "OAuth2 авторизация через GitHub",
        "flows": {
          "authorizationCode": {
            "authorizationUrl": "https://github.com/login/oauth/authorize",
            "tokenUrl": "https://github.com/login/oauth/access_token",
            "scopes": {
              "user:email": "Доступ к email пользователя",
              "read:user": "Доступ к профилю пользователя"
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Auth",
      "description": "Аутентификация и авторизация по email/password"
    },
    {
      "name": "Email Verification",
      "description": "Верификация email после регистрации"
    },
    {
      "name": "Password Recovery",
      "description": "Восстановление пароля"
    },
    {
      "name": "OAuth2",
      "description": "Авторизация через внешних провайдеров (Google, GitHub, Yandex, VK)"
    }
  ]
}
